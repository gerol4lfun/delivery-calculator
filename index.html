<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор доставки и стоимости теплиц</title>
    <!-- Яндекс.Карты -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=410a6099-56c9-4669-81c8-f21896edfab0&lang=ru_RU" type="text/javascript"></script>
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.28.0/dist/umd/supabase.min.js"></script>
    <style>
        /* Основные стили */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f9;
            color: #333;
        }
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            position: relative;
        }
        input[type="text"], input[type="password"], select, button {
            padding: 8px;
            margin: 5px 0;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background: #007BFF;
            color: #fff;
            cursor: pointer;
            border: none;
            width: 100%;
        }
        button:hover {
            background: #0056b3;
        }
        .hidden {
            display: none;
        }
        label {
            font-size: 14px;
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .auth-container h2, .block h2 {
            margin-bottom: 20px;
            font-size: 18px;
            color: #fff;
            background-color: #6c757d; /* Нейтральный серый фон */
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .auth-container p {
            color: red;
            display: none;
            margin: 10px 0;
        }
        .container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .block {
            flex: 1 1 45%;
            padding: 20px;
            border-right: 1px solid #ddd;
            box-sizing: border-box;
            min-width: 300px;
        }
        .block:last-child {
            border-right: none;
        }
        .logout {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f5f5f5;
            color: #555;
            border: 1px solid #ddd;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            width: auto;
        }
        .logout:hover {
            background-color: #e0e0e0;
            color: #000;
        }
        .parameters {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .parameters label {
            width: 40%;
            margin-right: 10px;
            text-align: left;
            padding-right: 10px;
            box-sizing: border-box;
        }
        .parameters select {
            width: 60%;
            text-align: center; /* Центрирование текста внутри select */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-position: right 10px center;
            background-repeat: no-repeat;
            background-size: 10px;
        }
        /* Стили для центрирования текста в опциях select */
        select option {
            text-align: center;
        }
        .additional-services, .additional-products {
            margin-top: 20px;
        }
        .checkbox-group-large {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .checkbox-group-large label {
            width: 48%;
            text-align: left;
            font-weight: normal;
        }
        .additional-products h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }
        .additional-products label {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
        }
        #result, #summary {
            margin-top: 20px;
            font-size: 16px;
            color: #007BFF;
            text-align: center;
        }
        #map {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            border-radius: 8px;
        }
        .summary {
            margin-top: 20px;
            font-size: 16px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Авторизация -->
    <div class="auth-container" id="auth-container">
        <h2>Вход в систему</h2>
        <input type="text" id="login" placeholder="Введите логин" required>
        <input type="password" id="password" placeholder="Введите пароль" required>
        <button onclick="authenticate()">Войти</button>
        <p id="auth-error">Неверный логин или пароль!</p>
    </div>

    <!-- Калькулятор -->
    <div class="calculator-container hidden" id="calculator-container">
        <div class="container">
            <button class="logout" onclick="logout()">Выйти</button>
            
            <!-- Блок доставки -->
            <div class="block">
                <h2>Доставка</h2>
                <label for="address">Введите адрес доставки:</label>
                <input type="text" id="address" placeholder="Например, Санкт-Петербург, Невский пр." required autocomplete="off">
                
                <label><input type="radio" name="deliveryType" value="withoutAssembly" checked> Без сборки</label>
                <label><input type="radio" name="deliveryType" value="withAssembly"> Со сборкой</label>

                <button onclick="calculateDelivery()">Рассчитать доставку</button>
                <div id="result"></div>
                <div id="map"></div>
            </div>

            <!-- Блок теплицы -->
            <div class="block">
                <h2>Стоимость теплицы</h2>
                
                <div class="parameters">
                    <label for="city">Город:</label>
                    <select id="city" onchange="onCityChange()">
                        <option value="">Выберите город</option>
                    </select>
                </div>

                <div class="parameters">
                    <label for="form">Форма теплицы:</label>
                    <select id="form" onchange="onFormChange()">
                        <option value="">Сначала выберите город</option>
                    </select>
                </div>
                
                <div class="parameters">
                    <label for="width">Ширина (м):</label>
                    <select id="width" onchange="onWidthChange()">
                        <option value="">Выберите ширину</option>
                    </select>
                </div>
                
                <div class="parameters">
                    <label for="length">Длина (м):</label>
                    <select id="length" onchange="onLengthChange()">
                        <option value="">Выберите длину</option>
                    </select>
                </div>
                
                <div class="parameters">
                    <label for="frame">Каркас:</label>
                    <select id="frame" onchange="onFrameChange()">
                        <option value="">Сначала выберите длину</option>
                    </select>
                </div>

                <div class="parameters">
                    <label for="polycarbonate">Поликарбонат:</label>
                    <select id="polycarbonate">
                        <option value="">Сначала выберите город</option>
                    </select>
                </div>

                <div class="parameters">
                    <label for="arcStep">Шаг между дугами:</label>
                    <select id="arcStep">
                        <option value="">Выберите шаг</option>
                        <option value="1">1 м</option>
                        <option value="0.65">0.65 м</option>
                    </select>
                </div>

                <!-- Дополнительные услуги -->
                <div class="additional-services">
                    <div class="checkbox-group-large">
                        <label><input type="checkbox" id="bracing"> Брус (+2000 руб.)</label>
                        <label><input type="checkbox" id="assembly"> Сборка (+5000 руб.)</label>
                        <label><input type="checkbox" id="ground-hooks"> Штыри (+1500 руб.)</label>
                    </div>
                    <p>Монтаж на фундамент клиента</p>
                    <div class="checkbox-group-large">
                        <label><input type="checkbox" id="on-wood"> На брус</label>
                        <label><input type="checkbox" id="on-concrete"> На бетон</label>
                    </div>
                </div>

                <div class="additional-products">
                    <h3>Дополнительные товары:</h3>
                    <label>
                        Капельный полив
                        <input type="checkbox" id="drip-irrigation">
                    </label>
                    <label>
                        Автомат для форточки
                        <input type="checkbox" id="window-automation">
                    </label>
                    <label>
                        Оцинкованная лента
                        <input type="checkbox" id="galvanized-tape">
                    </label>
                </div>

                <button onclick="calculateGreenhouseCost()">Рассчитать стоимость теплицы</button>
            </div>

            <!-- Блок итогового расчета -->
            <div class="block">
                <h2>Итоговый расчет</h2>
                <div class="summary" id="summary">
                    Здесь будет выводиться итоговая сумма и детали расчета.
                </div>
            </div>
        </div>

        <script>
            const DEBUG = true; // Включение режима отладки

            // Функция нормализации строк (убирает пробелы и приводит к нижнему регистру)
            function normalizeString(str) {
                return str.trim().toLowerCase();
            }

            // Инициализация Supabase
            const SUPABASE_URL = 'https://dyoibmfdohpvjltfaygr.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5b2libWZkb2hwdmpsdGZheWdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM5ODAxMzcsImV4cCI6MjA0OTU1NjEzN30.ZHj1JJsmSN45-0cv83uJDpaqtv3R6_U7CZmbkK-H24s'; // Ваш Anon Public Key

            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            let currentCityData = []; // Данные по выбранному городу

            // Определение доступных форм теплиц и их названий
            const availableForms = {
                "Арочная": [
                    "ТЕПЛИЦА БОЯРСКАЯ 2.5М", 
                    "ТЕПЛИЦА БОЯРСКАЯ 3М", 
                    "ТЕПЛИЦА БОЯРСКАЯ ЛЮКС 2.5М", 
                    "ТЕПЛИЦА БОЯРСКАЯ ЛЮКС 3М", 
                    "ТЕПЛИЦА БОЯРСКАЯ ЛЮКС 3.5М", 
                    "ТЕПЛИЦА БОЯРСКАЯ ДЕЛЮКС 2.5М", 
                    "ТЕПЛИЦА БОЯРСКАЯ ДЕЛЮКС 3М", 
                    "ТЕПЛИЦА БОЯРСКАЯ ПРЕМИУМ 2.5М", 
                    "ТЕПЛИЦА БОЯРСКАЯ ПРЕМИУМ 3М", 
                    "ТЕПЛИЦА БОЯРСКАЯ ПРЕМИУМ 3.5М", 
                    "ТЕПЛИЦА БОЯРСКАЯ ПРЕМИУМ 4М"
                ],
                "Каплевидная": [
                    "ТЕПЛИЦА СТРЕЛЕЦКАЯ ЛЮКС 2.5М", 
                    "ТЕПЛИЦА СТРЕЛЕЦКАЯ ЛЮКС 3М", 
                    "ТЕПЛИЦА СТРЕЛЕЦКАЯ ЛЮКС 3.5М"
                ],
                "Прямостенная": [
                    "ТЕПЛИЦА ЦАРСКАЯ ЛЮКС 2.5М", 
                    "ТЕПЛИЦА ЦАРСКАЯ ЛЮКС 3М", 
                    "ТЕПЛИЦА ЦАРСКАЯ ЛЮКС 3.5М", 
                    "ТЕПЛИЦА ЦАРСКАЯ ПРЕМИУМ 2.5М", 
                    "ТЕПЛИЦА ЦАРСКАЯ ПРЕМИУМ 3М", 
                    "ТЕПЛИЦА ЦАРСКАЯ ПРЕМИУМ 3.5М", 
                    "ТЕПЛИЦА ЦАРСКАЯ ПРЕМИУМ 4М"
                ],
                "Домиком": [
                    "ТЕПЛИЦА ДОМИК ЛЮКС 2.5М", 
                    "ТЕПЛИЦА ДОМИК ЛЮКС 3М", 
                    "ТЕПЛИЦА ДОМИК ЛЮКС 3.5М", 
                    "ТЕПЛИЦА ДОМИК ПРЕМИУМ 2.5М", 
                    "ТЕПЛИЦА ДОМИК ПРЕМИУМ 3М", 
                    "ТЕПЛИЦА ДОМИК ПРЕМИУМ 3.5М", 
                    "ТЕПЛИЦА ДОМИК ПРЕМИУМ 4М"
                ],
                "Пристенная": [
                    "ТЕПЛИЦА ПРИСТЕННАЯ ЛЮКС 2.5М", 
                    "ТЕПЛИЦА ПРИСТЕННАЯ ЛЮКС 3М", 
                    "ТЕПЛИЦА ПРИСТЕННАЯ ПРЕМИУМ 2.5М", 
                    "ТЕПЛИЦА ПРИСТЕННАЯ ПРЕМИУМ 3М"
                ],
                "Митлайдер арочная": [
                    "ТЕПЛИЦА МИТЛАЙДЕР ЛЮКС 3М", 
                    "ТЕПЛИЦА МИТЛАЙДЕР ЛЮКС 3.5М", 
                    "ТЕПЛИЦА МИТЛАЙДЕР ПРЕМИУМ 3М", 
                    "ТЕПЛИЦА МИТЛАЙДЕР ПРЕМИУМ 3.5М"
                ],
                "Митлайдер прямостенная": [
                    "ТЕПЛИЦА МИТЛАЙДЕР ЭЛИТ 3М", 
                    "ТЕПЛИЦА МИТЛАЙДЕР ЭЛИТ 3.5М"
                ],
                "Промышленная прямостенная": [
                    "ТЕПЛИЦА ПРЕМЬЕР ПРЕМИУМ 5М", 
                    "ТЕПЛИЦА ПРЕМЬЕР ПРЕМИУМ 6М"
                ],
                "Промышленная домиком": [
                    "ТЕПЛИЦА МОНАРХ ПРЕМИУМ 7М", 
                    "ТЕПЛИЦА МОНАРХ ПРЕМИУМ 8М"
                ],
                "Навес": [
                    "НАВЕС ЛЮКС 3.5М", 
                    "НАВЕС ЛЮКС 4М", 
                    "НАВЕС ПРЕМИУМ 5М", 
                    "НАВЕС ПРЕМИУМ 6М"
                ]
            };

            function getFormCategory(formName) {
                console.log("Анализ form_name:", formName); // Лог для отладки

                // Приводим название к удобному формату:
                const cleanName = formName
                    .replace(/ТЕПЛИЦА\s*/gi, "")       // Убираем слово "ТЕПЛИЦА" и пробелы
                    .replace(/\d+(\.\d+)?М/gi, "")     // Удаляем размеры, например "2.5М", "3М"
                    .replace(/\s{2,}/g, " ")           // Убираем лишние пробелы
                    .trim();                           // Очищаем пробелы по краям

                console.log("Очищенное имя для анализа:", cleanName);

                // Категории форм теплиц с ключевыми словами
                if (/БОЯРСКАЯ/gi.test(cleanName)) {
                    return "Арочная";
                }
                if (/СТРЕЛЕЦКАЯ/gi.test(cleanName)) {
                    return "Каплевидная";
                }
                if (/ЦАРСКАЯ|ПРЯМОСТЕННАЯ/gi.test(cleanName)) {
                    return "Прямостенная";
                }
                if (/ДОМИК/gi.test(cleanName)) {
                    return "Домиком";
                }
                if (/ПРИСТЕННАЯ/gi.test(cleanName)) {
                    return "Пристенная";
                }
                if (/МИТЛАЙДЕР/gi.test(cleanName)) {
                    return "Митлайдер";
                }
                if (/НАВЕС/gi.test(cleanName)) {
                    return "Навес";
                }
                if (/ПРОМЫШЛЕННАЯ|ПРОМЫШЛЕННЫЕ/gi.test(cleanName)) {
                    return "Промышленная";
                }
                if (/ЭКОНОМ/gi.test(cleanName)) {
                    return "Эконом";
                }
                if (/ЛЮКС/gi.test(cleanName)) {
                    return "Люкс";
                }
                if (/ПОЛИКАРБОНАТ/gi.test(cleanName)) {
                    return "Поликарбонат";
                }

                return "Прочие"; // Если ничего не совпадает
            }

            // Пользователи
            const users = [
                { login: "admin", password: "Admin#2024" },
                { login: "Manager1", password: "Mng1!Secure" },
                { login: "Manager2", password: "Mng2#Strong" },
                { login: "Manager3", password: "Mng3!Complex" },
                { login: "Manager4", password: "Mng4#Robust" },
                { login: "Manager5", password: "Mng5!Power" },
                { login: "Manager6", password: "Mng6#Safety" },
                { login: "Manager7", password: "Mng7!Stable" },
                { login: "Manager8", password: "Mng8#Access" },
                { login: "Manager9", password: "Mng9!Control" },
                { login: "Manager10", password: "Mng10#Secure" }
            ];

            // Приоритеты форм (чем меньше число, тем выше в списке)
            const formPriority = {
                "Арочная": 1,
                "Каплевидная": 2,
                "Прямостенная": 3,
                "Домиком": 4,
                "Пристенная": 5,
                "Митлайдер арочная": 6,
                "Митлайдер прямостенная": 7,
                "Промышленная прямостенная": 8,
                "Промышленная домиком": 9,
                "Навес": 10
                // "Прочие": 11
            };

            // Регионы доставки
            const deliveryRegions = [
                { city: "Москва", region: "Московская область" },
                { city: "Санкт-Петербург", region: "Ленинградская область" },
                { city: "Белгород", region: "Белгородская область" },
                { city: "Великий Новгород", region: "Новгородская область" },
                { city: "Владимир", region: "Владимирская область" },
                { city: "Вологда", region: "Вологодская область" },
                { city: "Воронеж", region: "Воронежская область" },
                { city: "Екатеринбург", region: "Свердловская область" },
                { city: "Иваново", region: "Ивановская область" },
                { city: "Йошкар-Ола", region: "Республика Марий Эл" },
                { city: "Казань", region: "Республика Татарстан" },
                { city: "Калуга", region: "Калужская область" },
                { city: "Кемерово", region: "Кемеровская область" },
                { city: "Кострома", region: "Костромская область" },
                { city: "Краснодар", region: "Краснодарский край" },
                { city: "Курск", region: "Курская область" },
                { city: "Липецк", region: "Липецкая область" },
                { city: "Майкоп", region: "Республика Адыгея" },
                { city: "Набережные Челны", region: "Республика Татарстан" },
                { city: "Нижний Новгород", region: "Нижегородская область" },
                { city: "Новосибирск", region: "Новосибирская область" },
                { city: "Орёл", region: "Орловская область" },
                { city: "Рязань", region: "Рязанская область" },
                { city: "Ставрополь", region: "Ставропольский край" },
                { city: "Тамбов", region: "Тамбовская область" },
                { city: "Тверь", region: "Тверская область" },
                { city: "Тула", region: "Тульская область" },
                { city: "Ульяновск", region: "Ульяновская область" },
                { city: "Чебоксары", region: "Чувашская Республика" },
                { city: "Челябинск", region: "Челябинская область" },
                { city: "Черкесск", region: "Карачаево-Черкесская Республика" },
                { city: "Ярославль", region: "Ярославская область" }
            ];

            // Города для карты
            const citiesForMap = [
                { name: "Москва", coords: [55.751244, 37.618423], boundaryDistance: 20 },
                { name: "Санкт-Петербург", coords: [59.934280, 30.335099], boundaryDistance: 20 },
                { name: "Белгород", coords: [50.597735, 36.585823], boundaryDistance: 10 },
                { name: "Великий Новгород", coords: [58.521400, 31.275505], boundaryDistance: 10 },
                { name: "Владимир", coords: [56.129057, 40.407031], boundaryDistance: 12 },
                { name: "Вологда", coords: [59.220492, 39.891568], boundaryDistance: 10 },
                { name: "Воронеж", coords: [51.661535, 39.200287], boundaryDistance: 15 },
                { name: "Екатеринбург", coords: [56.838926, 60.605703], boundaryDistance: 15 },
                { name: "Иваново", coords: [57.000348, 40.973921], boundaryDistance: 12 },
                { name: "Йошкар-Ола", coords: [56.634431, 47.899888], boundaryDistance: 12 },
                { name: "Казань", coords: [55.796391, 49.108891], boundaryDistance: 15 },
                { name: "Калуга", coords: [54.506043, 36.251593], boundaryDistance: 12 },
                { name: "Кемерово", coords: [55.354968, 86.087314], boundaryDistance: 15 },
                { name: "Кострома", coords: [57.767961, 40.926858], boundaryDistance: 10 },
                { name: "Краснодар", coords: [45.035470, 38.975313], boundaryDistance: 12 },
                { name: "Курск", coords: [51.730361, 36.192647], boundaryDistance: 10 },
                { name: "Липецк", coords: [52.610150, 39.594180], boundaryDistance: 12 },
                { name: "Майкоп", coords: [44.607782, 40.105690], boundaryDistance: 10 },
                { name: "Набережные Челны", coords: [55.727110, 52.404913], boundaryDistance: 12 },
                { name: "Нижний Новгород", coords: [56.296504, 43.936059], boundaryDistance: 15 },
                { name: "Новосибирск", coords: [55.008352, 82.935733], boundaryDistance: 15 },
                { name: "Орёл", coords: [52.967257, 36.069647], boundaryDistance: 10 },
                { name: "Рязань", coords: [54.629704, 39.741146], boundaryDistance: 12 },
                { name: "Ставрополь", coords: [45.044838, 41.969230], boundaryDistance: 10 },
                { name: "Тамбов", coords: [52.721219, 41.452274], boundaryDistance: 10 },
                { name: "Тверь", coords: [56.858539, 35.917596], boundaryDistance: 12 },
                { name: "Тула", coords: [54.193122, 37.617348], boundaryDistance: 12 },
                { name: "Ульяновск", coords: [54.316685, 48.403123], boundaryDistance: 12 },
                { name: "Чебоксары", coords: [56.146223, 47.251931], boundaryDistance: 12 },
                { name: "Челябинск", coords: [55.164442, 61.436843], boundaryDistance: 15 },
                { name: "Черкесск", coords: [44.226863, 42.046782], boundaryDistance: 10 },
                { name: "Ярославль", coords: [57.626559, 39.893813], boundaryDistance: 10 }
            ];

            let mapInstance;
            let currentRoute;

            ymaps.ready(() => {
                console.log("Инициализация Яндекс.Карт...");
                mapInstance = new ymaps.Map("map", {
                    center: [55.751244, 37.618423],
                    zoom: 7
                });
                console.log("Яндекс.Карты инициализированы.");
            });

            // Функция аутентификации
            function authenticate() {
                const loginInput = document.getElementById("login");
                const passwordInput = document.getElementById("password");
                const authError = document.getElementById("auth-error");

                const login = loginInput.value.trim();
                const password = passwordInput.value.trim();

                console.log("Попытка авторизации пользователя:", login);

                // Проверяем логин и пароль
                const user = users.find(u => u.login === login && u.password === password);

                if (user) {
                    console.log("Пользователь успешно аутентифицирован:", login);
                    // Если пользователь найден, скрываем окно авторизации и показываем калькулятор
                    authError.style.display = "none";
                    localStorage.setItem('savedLogin', login); // Сохраняем логин
                    document.getElementById("auth-container").classList.add("hidden");
                    document.getElementById("calculator-container").classList.remove("hidden");
                    initializeCalculator();
                } else {
                    console.warn("Неудачная попытка авторизации пользователя:", login);
                    // Если пользователь не найден — показываем ошибку
                    authError.style.display = "block";
                }
            }

            // Функция выхода
            function logout() {
                const savedLogin = localStorage.getItem('savedLogin');
                console.log("Пользователь вышел из системы:", savedLogin);
                localStorage.removeItem('savedLogin');
                document.getElementById("auth-container").classList.remove("hidden");
                document.getElementById("calculator-container").classList.add("hidden");
            }

            // Функция для загрузки городов из Supabase с учётом пагинации
            async function loadCities() {
                console.log("Загрузка городов из Supabase с учётом пагинации...");

                const pageSize = 1000; // Максимальное количество строк за один запрос
                let allCities = [];
                let page = 0;

                while (true) {
                    // Запрос данных с пагинацией
                    let { data, error } = await supabaseClient
                        .from('prices')
                        .select('city_name') // Запрашиваем города
                        .range(page * pageSize, (page + 1) * pageSize - 1); // Пагинация

                    if (error) {
                        console.error("Ошибка при загрузке городов из Supabase:", error);
                        return;
                    }

                    console.log(`Получено ${data.length} городов на странице ${page + 1}`);

                    // Если данных на странице меньше, чем pageSize, значит, это последняя страница
                    if (data.length === 0) break;

                    // Добавляем города в общий массив
                    allCities = allCities.concat(data.map(item => item.city_name));
                    page++;
                }

                console.log("Все города загружены:", allCities);

                // Убираем дубликаты городов
                let uniqueCities = [...new Set(allCities)];

                // Приоритетные города
                const priorityCities = ["Москва", "Санкт-Петербург"];

                // Удаляем приоритетные города из основного списка
                uniqueCities = uniqueCities.filter(city => !priorityCities.includes(city));

                // Сортируем оставшиеся города по алфавиту
                uniqueCities.sort((a, b) => a.localeCompare(b, 'ru'));

                // Объединяем приоритетные города и отсортированные города
                const finalCities = [...priorityCities, ...uniqueCities];

                // Обновляем выпадающий список
                const cityDropdown = document.getElementById('city');
                cityDropdown.innerHTML = '<option value="">Выберите город</option>';
                finalCities.forEach(city => {
                    cityDropdown.innerHTML += `<option value="${city}">${city}</option>`;
                });

                console.log("Выпадающий список городов обновлён с учётом приоритетов и пагинации.");
            }

            // Функция обработки изменения города
            async function onCityChange() {
                const city = document.getElementById('city').value;
                console.log("Выбран город:", city);

                // Если город не выбран – сбрасываем все поля
                if (!city) {
                    console.log("Город не выбран, сбрасываем формы, размеры и каркасы");
                    document.getElementById('form').innerHTML = '<option value="">Сначала выберите город</option>';
                    document.getElementById('width').innerHTML = '<option value="">Сначала выберите форму</option>';
                    document.getElementById('length').innerHTML = '<option value="">Сначала выберите ширину</option>';
                    document.getElementById('frame').innerHTML = '<option value="">Сначала выберите длину</option>';
                    return;
                }

                console.log(`Получение данных для города: ${city}`);
                let { data, error } = await supabaseClient
                    .from('prices')
                    .select('form_name, polycarbonate_type, width, length, frame_description') // Добавляем необходимые поля
                    .eq('city_name', city)
                    .limit(30000);

                if (DEBUG) {
                    console.log("Результат запроса Supabase:", { data, error });
                }

                if (!data || data.length === 0) {
                    console.warn("Данные для города отсутствуют или пусты:", city);
                    if (DEBUG) console.log("Ответ от сервера:", data);
                    alert("Данные для выбранного города не найдены. Попробуйте другой город.");
                    return; // Остановить выполнение функции
                } else {
                    console.log("Данные для города успешно загружены:", data);
                }

                // Логи для отладки
                console.log("Данные для выбранного города:", data);
                console.log("Ошибка при получении данных по городу:", error);

                if (error) {
                    console.error('Ошибка при получении данных по городу:', error);
                    return;
                }

                currentCityData = data;

                // 1. Обновляем выпадающий список поликарбоната
                const polycarbonateDropdown = document.getElementById('polycarbonate');
                polycarbonateDropdown.innerHTML = '<option value="">Выберите поликарбонат</option>';

                const uniquePoly = [...new Set(currentCityData.map(g => g.polycarbonate_type).filter(Boolean))];
                console.log("Уникальные типы поликарбоната:", uniquePoly);

                uniquePoly.forEach(poly => {
                    const option = document.createElement('option');
                    option.value = poly;
                    option.textContent = poly;
                    polycarbonateDropdown.appendChild(option);
                });

                console.log("Выпадающий список поликарбоната обновлён.");
                
                if (!availableForms) {
                    console.warn("Список доступных форм не загружен!");
                    return; // Остановить выполнение функции
                }

                // Фильтруем формы на основе availableForms
                const formNames = Object.keys(availableForms).filter(formType =>
                    data.some(item => availableForms[formType].some(name => item.form_name.includes(name)))
                );

                // Сортируем формы по приоритету
                formNames.sort((a, b) => (formPriority[a] || 100) - (formPriority[b] || 100)); // Прочие формы получат низкий приоритет

                // Обновляем выпадающий список форм теплиц
                const formDropdown = document.getElementById('form');
                formDropdown.innerHTML = '<option value="">Выберите форму</option>';
                formNames.forEach(form => {
                    if (form && form !== "Прочие") { // Исключаем пустые и ненужные категории
                        const option = document.createElement('option');
                        option.value = form;
                        option.textContent = form;
                        formDropdown.appendChild(option);
                    }
                });

                console.log("Выпадающий список форм теплиц обновлён.");

                // 3. Сбрасываем размеры и каркасы
                document.getElementById('width').innerHTML = '<option value="">Сначала выберите форму</option>';
                document.getElementById('length').innerHTML = '<option value="">Сначала выберите ширину</option>';
                document.getElementById('frame').innerHTML = '<option value="">Сначала выберите длину</option>';
                console.log("Размеры и каркасы сброшены.");
            }

            // Функция обработки изменения формы
            async function onFormChange() {
                const form = document.getElementById("form").value;
                console.log(`Выбрана форма: ${form}`);

                const widthSelect = document.getElementById("width");
                widthSelect.innerHTML = '<option value="">Выберите ширину</option>';

                if (!form) {
                    console.warn("Форма не выбрана!");
                    return;
                }

                if (!availableForms[form]) {
                    console.warn(`Не найдены доступные формы для: ${form}`);
                    return;
                }

                console.log("Фильтруемая форма:", form);
                console.log("Все доступные form_name:", currentCityData.map(g => g.form_name));

                // Фильтруем данные по выбранной форме на основе availableForms
                const filteredData = currentCityData.filter(item =>
                    availableForms[form] && availableForms[form].some(name => 
                        normalizeString(item.form_name).includes(normalizeString(name))
                    )
                );

                // Проверка на пустые данные
                if (filteredData.length === 0) {
                    console.warn("Данные после фильтрации пусты. Проверьте параметры.");
                    alert("Теплица с указанными параметрами не найдена. Попробуйте выбрать другие параметры.");
                    return; // Останавливаем выполнение функции, если данных нет
                }

                console.log("Отфильтрованные данные:", filteredData);

                // Получаем уникальные значения ширины
                const uniqueWidths = [...new Set(filteredData.map(item => item.width))].sort((a, b) => a - b);
                console.log("Уникальные ширины для формы:", uniqueWidths);

                // Заполняем выпадающий список ширины
                uniqueWidths.forEach(width => {
                    widthSelect.innerHTML += `<option value="${width}">${width} м</option>`;
                });

                console.log("Выпадающий список ширины обновлён.");

                // Сбрасываем длину и каркас
                document.getElementById('length').innerHTML = '<option value="">Сначала выберите ширину</option>';
                document.getElementById('frame').innerHTML = '<option value="">Сначала выберите длину</option>';
                console.log("Длина и каркас сброшены.");
            }

            // Функция обработки изменения ширины
            async function onWidthChange() {
                const form = document.getElementById("form").value;
                const width = parseFloat(document.getElementById("width").value);
                console.log(`Выбрана ширина: ${width} м для формы: ${form}`);

                const lengthSelect = document.getElementById("length");
                lengthSelect.innerHTML = '<option value="">Выберите длину</option>';

                if (isNaN(width)) {
                    console.warn("Ширина не выбрана!");
                    return;
                }

                console.log("Форма для фильтрации:", form);
                console.log("Очищенные названия form_name:", currentCityData.map(item => getFormCategory(item.form_name)));

                // Фильтруем данные по выбранной форме и ширине
                const filteredData = currentCityData.filter(item =>
                    availableForms[form].some(name => item.form_name.includes(name)) &&
                    item.width === width
                );

                // Проверка на пустые данные после фильтрации
                if (filteredData.length === 0) {
                    console.warn("Данные после фильтрации пусты. Проверьте параметры.");
                    alert("Теплица с указанными параметрами не найдена. Попробуйте выбрать другие параметры.");
                    return; // Останавливаем выполнение функции
                }

                console.log("Отфильтрованные данные по ширине:", filteredData);

                // Получаем уникальные значения длины
                const uniqueLengths = [...new Set(filteredData.map(item => item.length))].sort((a, b) => a - b);
                console.log("Уникальные длины для выбранной формы и ширины:", uniqueLengths);

                // Заполняем выпадающий список длины
                uniqueLengths.forEach(length => {
                    lengthSelect.innerHTML += `<option value="${length}">${length} м</option>`;
                });

                console.log("Выпадающий список длины обновлён.");

                // Сбрасываем каркас
                document.getElementById('frame').innerHTML = '<option value="">Сначала выберите длину</option>';
                console.log("Каркас сброшен.");
            }

            // Функция обработки изменения длины
            async function onLengthChange() {
                const form = document.getElementById("form").value;
                const width = parseFloat(document.getElementById("width").value);
                const length = parseFloat(document.getElementById("length").value);
                console.log(`Выбрана длина: ${length} м для формы: ${form} и ширины: ${width} м`);

                const frameSelect = document.getElementById("frame");
                frameSelect.innerHTML = '<option value="">Выберите каркас</option>';

                if (isNaN(length)) {
                    console.warn("Длина не выбрана!");
                    return;
                }

                // Фильтруем данные по выбранной форме, ширине и длине
                const filteredData = currentCityData.filter(item =>
                    availableForms[form].some(name => item.form_name.includes(name)) &&
                    item.width === width &&
                    item.length === length
                );

                // Проверка на пустые данные после фильтрации
                if (filteredData.length === 0) {
                    console.warn("Данные после фильтрации пусты. Проверьте параметры.");
                    alert("Теплица с указанными параметрами не найдена. Попробуйте выбрать другие параметры.");
                    return;
                }

                console.log("Отфильтрованные данные по длине:", filteredData);

                // Получаем уникальные описания каркасов
                const uniqueFrames = [...new Set(filteredData.map(item => item.frame_description))].sort();
                console.log("Уникальные каркасы для выбранных параметров:", uniqueFrames);

                // Заполняем выпадающий список каркаса
                uniqueFrames.forEach(frame => {
                    // Извлечение числовой части каркаса, включая возможный знак "+"
                    const numericFrameMatch = frame.match(/(\d{1,2})х(\d{1,2})(?:\s?\+\s?\d{1,2}х\d{1,2})?/);
                    const numericFrame = numericFrameMatch ? numericFrameMatch[0] : frame; // Если совпадение найдено, используем его

                    const option = document.createElement('option');
                    option.value = frame; // Сохраняем оригинальное описание для запроса
                    option.textContent = numericFrame; // Отображаем только числовую часть
                    frameSelect.appendChild(option);
                });

                console.log("Выпадающий список каркаса обновлён.");

                // Автоматический выбор каркаса, если доступен только один
                if (uniqueFrames.length === 1) {
                    frameSelect.value = uniqueFrames[0];
                    console.log("Автоматически выбран каркас:", uniqueFrames[0]);
                }
            }

            // Функция расчёта стоимости теплицы
            async function calculateGreenhouseCost() {
                const city = document.getElementById("city").value;
                const form = document.getElementById("form").value;
                const width = parseFloat(document.getElementById("width").value);
                const length = parseFloat(document.getElementById("length").value);
                const frame = document.getElementById("frame").value;
                const polycarbonate = document.getElementById("polycarbonate").value;
                const arcStep = parseFloat(document.getElementById("arcStep").value);

                console.log("Начинается расчёт стоимости теплицы с параметрами:", {
                    city, form, width, length, frame, polycarbonate, arcStep
                });

                // Проверка на заполнение всех обязательных полей
                if (!city || !form || isNaN(width) || isNaN(length) || !frame || !polycarbonate || isNaN(arcStep)) {
                    console.warn("Пользователь не заполнил все обязательные поля.");
                    alert("Пожалуйста, заполните все обязательные поля.");
                    return;
                }

                // Логирование параметров запроса
                console.log("Параметры запроса:", {
                    city,
                    form,
                    width,
                    length,
                    frame,
                    polycarbonate
                });

                // Запрос к Supabase с фильтрацией по городу
                console.log("Отправка запроса к Supabase для получения данных по городу...");
                let { data, error } = await supabaseClient
                    .from('prices')
                    .select('*')
                    .eq('city_name', city) // Запрашиваем только по городу
                    .limit(100); // Ограничиваем результат 100 строками для проверки

                console.log("Данные из Supabase по городу:", data);
                console.log("Ошибка при запросе данных:", error);

                if (error || !data) { // Проверяем ошибку сразу
                    console.error("Ошибка при получении данных:", error);
                    alert("Теплица с заданными параметрами не найдена.");
                    return;
                }

                // Логируем все строки из Supabase для проверки
                console.log("Все строки из Supabase по городу:");
                data.forEach((item, index) => {
                    console.log(`Строка ${index + 1}:`, {
                        form_name: item.form_name,
                        width: item.width,
                        length: item.length,
                        frame_description: item.frame_description,
                        polycarbonate_type: item.polycarbonate_type
                    });
                });

                // Проверка введённых параметров для фильтрации
                console.log("Введённые параметры для сравнения:", {
                    form_name: form,
                    width: width,
                    length: length,
                    frame_description: frame,
                    polycarbonate_type: polycarbonate
                });

                // Фильтрация вручную
                const filteredResult = data.filter(item => {
                    // Логируем категорию формы для отладки
                    const category = getFormCategory(item.form_name);
                    console.log("Анализ категории формы:", item.form_name, "Результат:", category);

                    return (
                        item.city_name.trim().toLowerCase() === city.trim().toLowerCase() &&
                        category === form &&
                        parseFloat(item.width) === width &&
                        parseFloat(item.length) === length &&
                        item.frame_description.trim().toLowerCase() === frame.trim().toLowerCase() &&
                        item.polycarbonate_type.trim().toLowerCase() === polycarbonate.trim().toLowerCase()
                    );
                });

                // Проверка, что после фильтрации остались данные
                if (filteredResult.length === 0) {
                    console.warn("Теплица с такими параметрами не найдена.");
                    alert("Теплица с заданными параметрами не найдена.");
                    return;
                }

                // Логируем отфильтрованные данные
                console.log("Результаты фильтрации:", filteredResult);

                // Выбираем первую подходящую цену
                let basePrice = filteredResult[0].price;
                console.log("Базовая цена теплицы:", basePrice);

                // Дополнительные услуги
                const assemblyCost = document.getElementById('assembly').checked ? 5000 : 0;
                const bracingCost = document.getElementById('bracing').checked ? 2000 : 0;
                const groundHooksCost = document.getElementById('ground-hooks').checked ? 1500 : 0;

                // Дополнительные товары
                const dripIrrigationCost = document.getElementById('drip-irrigation').checked ? 1000 : 0;
                const windowAutomationCost = document.getElementById('window-automation').checked ? 2500 : 0;
                const galvanizedTapeCost = document.getElementById('galvanized-tape').checked ? 800 : 0;

                // Логирование дополнительных услуг и товаров
                console.log("Дополнительные услуги:", { assembly: assemblyCost, bracing: bracingCost, groundHooks: groundHooksCost });
                console.log("Дополнительные товары:", { dripIrrigation: dripIrrigationCost, windowAutomation: windowAutomationCost, galvanizedTape: galvanizedTapeCost });

                const additionalServices = assemblyCost + bracingCost + groundHooksCost;
                const additionalProducts = dripIrrigationCost + windowAutomationCost + galvanizedTapeCost;

                console.log("Итого дополнительные услуги:", additionalServices);
                console.log("Итого дополнительные товары:", additionalProducts);

                // Стоимость дуг
                const arcCost = arcStep * 1000; 
                console.log("Стоимость дуг (arcCost):", arcCost);

                // Итоговая стоимость
                const totalPrice = basePrice + additionalServices + additionalProducts + arcCost;
                const roundedPrice = Math.ceil(totalPrice / 50) * 50;

                console.log("Итоговая стоимость теплицы:", roundedPrice);

                // Выводим итоговую стоимость
                document.getElementById("summary").innerText = `Итоговая стоимость теплицы: ${roundedPrice} руб.`;
            }

            // Функция расчёта доставки
            async function calculateDelivery() {
                console.log("Начинается расчёт доставки...");
                const addressInput = document.getElementById("address");
                const address = addressInput.value.trim().toLowerCase();
                const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;

                console.log("Введённый адрес:", address);
                console.log("Тип доставки:", deliveryType);

                if (!address) {
                    console.warn("Адрес не введён.");
                    document.getElementById('result').innerText = "Введите адрес!";
                    return;
                }

                try {
                    console.log("Выполняется геокодирование адреса...");
                    const res = await ymaps.geocode(address);
                    const geoObject = res.geoObjects.get(0);
                    console.log("Результат геокодирования:", geoObject);

                    if (!geoObject) {
                        console.warn("Адрес не найден.");
                        document.getElementById('result').innerText = "Адрес не найден!";
                        return;
                    }

                    const localities = geoObject.getLocalities().map(locality => locality.toLowerCase());
                    const administrativeAreas = geoObject.getAdministrativeAreas().map(area => area.toLowerCase());

                    console.log("Найденные населённые пункты:", localities);
                    console.log("Найденные административные области:", administrativeAreas);

                    const isInDeliveryRegion = deliveryRegions.some(region => 
                        localities.includes(region.city.toLowerCase()) || administrativeAreas.includes(region.region.toLowerCase())
                    );

                    console.log("Находится ли адрес в зоне доставки:", isInDeliveryRegion);

                    if (!isInDeliveryRegion) {
                        console.warn("Адрес вне зоны доставки.");
                        document.getElementById('result').innerText = "Доставка в этот регион не осуществляется.";
                        return;
                    }

                    const coords = geoObject.geometry.getCoordinates();
                    const destinationLat = coords[0];
                    const destinationLon = coords[1];

                    console.log("Координаты адреса:", [destinationLat, destinationLon]);

                    let nearestCity = null;
                    let minDistance = Infinity;

                    citiesForMap.forEach(city => {
                        const cityDistance = ymaps.coordSystem.geo.getDistance(city.coords, [destinationLat, destinationLon]) / 1000;
                        console.log(`Расстояние до города ${city.name}: ${cityDistance} км`);
                        if (cityDistance < minDistance) {
                            minDistance = cityDistance;
                            nearestCity = city;
                        }
                    });

                    console.log("Ближайший город:", nearestCity, "Расстояние:", minDistance, "км");

                    if (!nearestCity) {
                        console.warn("Не удалось определить ближайший город.");
                        document.getElementById('result').innerText = "Ошибка: ближайший город не найден.";
                        return;
                    }

                    mapInstance.setCenter(nearestCity.coords, 7);
                    console.log(`Центр карты установлен на ${nearestCity.name}`);

                    if (currentRoute) {
                        mapInstance.geoObjects.remove(currentRoute);
                        console.log("Предыдущий маршрут удалён.");
                    }

                    try {
                        console.log("Выполняется расчёт маршрута...");
                        const route = await ymaps.route([nearestCity.coords, [destinationLat, destinationLon]]);
                        currentRoute = route;
                        mapInstance.geoObjects.add(route);
                        console.log("Маршрут добавлен на карту:", route);

                        const distanceInKm = route.getLength() / 1000;
                        console.log("Длина маршрута:", distanceInKm, "км");

                        const distanceFromBoundary = Math.max(distanceInKm - nearestCity.boundaryDistance, 0);
                        console.log("Расстояние от границы города:", distanceFromBoundary, "км");

                        let cost;
                        if (deliveryType === "withoutAssembly") {
                            cost = Math.max(1000, 500 + 40 * distanceFromBoundary);
                            console.log("Стоимость доставки без сборки:", cost, "руб.");
                        } else {
                            cost = Math.max(1000, 40 * distanceFromBoundary);
                            console.log("Стоимость доставки со сборкой:", cost, "руб.");
                        }

                        const roundedCost = Math.ceil(cost / 50) * 50;
                        console.log("Округленная стоимость доставки:", roundedCost, "руб.");

                        document.getElementById('result').innerText = `Стоимость доставки: ${roundedCost} рублей (${nearestCity.name})`;
                    } catch (routeError) {
                        console.error("Ошибка при расчёте маршрута:", routeError);
                        document.getElementById('result').innerText = "Ошибка при расчёте маршрута.";
                    }

                } catch (geocodeError) {
                    console.error("Ошибка при геокодировании адреса:", geocodeError);
                    document.getElementById('result').innerText = "Ошибка при расчёте. Попробуйте снова.";
                }
            }

            // Инициализация при загрузке страницы
            window.onload = async function() {
                const savedLogin = localStorage.getItem('savedLogin');
                console.log("Загружается страница. Сохранённый логин:", savedLogin);
                if (savedLogin) {
                    document.getElementById("login").value = savedLogin;
                    document.getElementById("password").focus();
                    document.getElementById("auth-container").classList.add("hidden");
                    document.getElementById("calculator-container").classList.remove("hidden");
                    console.log("Выполняется инициализация калькулятора после автологина.");
                    await initializeCalculator();
                } else {
                    console.log("Пользователь не аутентифицирован. Показывается форма входа.");
                }
            }

            // Функция загрузки городов при инициализации калькулятора
            async function initializeCalculator() {
                console.log("Инициализация калькулятора: загрузка городов.");
                await loadCities();
                console.log("Загрузка городов завершена.");
            }
        </script>
    </div>
</body>
</html>
