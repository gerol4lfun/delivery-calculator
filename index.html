<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор доставки и стоимости теплиц</title>
    <!-- Яндекс.Карты -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=410a6099-56c9-4669-81c8-f21896edfab0&lang=ru_RU" type="text/javascript"></script>
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.28.0/dist/umd/supabase.min.js"></script>
    <style>
        /* Основные стили */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f9;
            color: #333;
        }
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .calculator-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            position: relative;
        }
        input[type="text"], input[type="password"], select, button, textarea {
            padding: 8px;
            margin: 5px 0;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background: #007BFF;
            color: #fff;
            cursor: pointer;
            border: none;
            width: 100%;
        }
        button:hover {
            background: #0056b3;
        }
        .hidden {
            display: none;
        }
        label {
            font-size: 14px;
            display: block;
            margin-bottom: 5px;
        }

        .auth-container h2, .block h2 {
            margin-bottom: 20px;
            font-size: 18px;
            color: #fff;
            background-color: #6c757d; /* Нейтральный серый фон */
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .auth-container p {
            color: red;
            display: none;
            margin: 10px 0;
        }
        /* 
         * !!! ВНИМАНИЕ: Ниже изменён размер flex: хотим 3 колонки !!!
         */
        .container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        /* Было flex: 1 1 45%, но нам нужно 3 колонки */
        .block {
            flex: 1 1 30%; 
            padding: 20px;
            border-right: 1px solid #ddd;
            box-sizing: border-box;
            min-width: 300px;
        }
        .block:last-child {
            border-right: none;
        }
        .logout {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f5f5f5;
            color: #555;
            border: 1px solid #ddd;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            width: auto;
        }
        .logout:hover {
            background-color: #e0e0e0;
            color: #000;
        }
        .parameters {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .parameters label {
            width: 40%;
            margin-right: 10px;
            text-align: left;
            padding-right: 10px;
            box-sizing: border-box;
        }
        .parameters select {
            width: 60%;
            text-align: center;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-position: right 10px center;
            background-repeat: no-repeat;
            background-size: 10px;
        }
        select option {
            text-align: center;
        }
        .additional-services, .additional-products {
            margin-top: 20px;
        }
        .checkbox-group-large {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .checkbox-group-large label {
            width: 48%;
            text-align: left;
            font-weight: normal;
            cursor: pointer;
        }
        .additional-products h3 {
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }
        .additional-products .product-item {
            margin-bottom: 10px;
        }
        .product-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .product-label input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
        }
        .product-label .product-name {
            flex-grow: 1;
            text-align: left;
            margin-left: 0;
        }
        .product-label .price {
            font-weight: bold;
            color: #000;
            white-space: nowrap;
        }
        #result, #map {
            margin-top: 20px;
            font-size: 16px;
            color: #007BFF;
            text-align: center;
            white-space: pre-wrap;
        }
        #map {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            border-radius: 8px;
        }
        /* 
         * !!! Удалён блок "Итоговый расчет" !!!
         * Вместо него — только 3 блока.
         */

        /* Текстовое поле КП */
        #commercial-offer {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 400px; 
            box-sizing: border-box;
            resize: vertical;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Авторизация -->
    <div class="auth-container" id="auth-container">
        <h2>Вход в систему</h2>
        <input type="text" id="login" placeholder="Введите логин" required>
        <input type="password" id="password" placeholder="Введите пароль" required>
        <button onclick="authenticate()">Войти</button>
        <p id="auth-error">Неверный логин или пароль!</p>
    </div>

    <!-- Калькулятор -->
    <div class="calculator-container hidden" id="calculator-container">
        <div class="container">
            <button class="logout" onclick="logout()">Выйти</button>
            
            <!-- Блок доставки -->
            <div class="block">
                <h2>Доставка</h2>
                <label for="address">Введите адрес доставки:</label>
                <input type="text" id="address" placeholder="Например, Санкт-Петербург, Невский пр." required autocomplete="off">
                
                <label><input type="radio" name="deliveryType" value="withoutAssembly" checked> Без сборки</label>
                <label><input type="radio" name="deliveryType" value="withAssembly"> Со сборкой</label>

                <button onclick="calculateDelivery()">Рассчитать доставку</button>
                <div id="result"></div>
                <div id="map"></div>
            </div>

            <!-- Блок теплицы -->
            <div class="block">
                <h2>Стоимость теплицы</h2>
                
                <div class="parameters">
                    <label for="city">Город:</label>
                    <select id="city" onchange="onCityChange()">
                        <option value="">Выберите город</option>
                    </select>
                </div>

                <!-- Форма: по умолчанию "Арочная" при наличии у города -->
                <div class="parameters">
                    <label for="form">Форма теплицы:</label>
                    <select id="form" onchange="onFormChange()">
                        <option value="">Сначала выберите город</option>
                    </select>
                </div>
                
                <div class="parameters">
                    <label for="width">Ширина (м):</label>
                    <select id="width" onchange="onWidthChange()">
                        <option value="">Выберите ширину</option>
                    </select>
                </div>
                
                <div class="parameters">
                    <label for="length">Длина (м):</label>
                    <select id="length" onchange="onLengthChange()">
                        <option value="">Выберите длину</option>
                    </select>
                </div>
                
                <div class="parameters">
                    <label for="frame">Каркас:</label>
                    <select id="frame" onchange="onFrameChange()">
                        <option value="">Выберите каркас</option>
                    </select>
                </div>

                <!-- Поликарбонат: упорядочим ("Стандарт 4 мм", "Люкс 4 мм", ...) -->
                <div class="parameters">
                    <label for="polycarbonate">Поликарбонат:</label>
                    <select id="polycarbonate">
                        <!-- Порядок переопределяется при выборе города -->
                    </select>
                </div>

                <!-- Шаг дуг: по умолчанию 1 м -->
                <div class="parameters">
                    <label for="arcStep">Шаг между дугами:</label>
                    <select id="arcStep">
                        <option value="1" selected>1 м</option>
                        <option value="0.65">0.65 м</option>
                    </select>
                </div>

                <div class="additional-services">
                    <div class="checkbox-group-large">
                        <label><input type="checkbox" id="bracing"> Брус</label>
                        <label><input type="checkbox" id="assembly"> Сборка</label>
                        <label><input type="checkbox" id="ground-hooks"> Штыри</label>
                    </div>
                    <p><strong>Монтаж на фундамент клиента</strong></p>
                    <div class="checkbox-group-large">
                        <label><input type="checkbox" id="on-wood" data-price="1500"> На брус +1.500 рублей</label>
                        <label><input type="checkbox" id="on-concrete" data-price="2000"> На бетон +2.000 рублей</label>
                    </div>
                </div>

                <div class="additional-products">
                    <h3>Дополнительные товары:</h3>
                    
                    <div class="product-item">
                        <label class="product-label">
                            <input type="checkbox" id="drip-irrigation-mech" data-price="1690">
                            <span class="product-name">Капельный полив механический</span>
                            <span class="price">1.690 рублей</span>
                        </label>
                    </div>
                    
                    <div class="product-item">
                        <label class="product-label">
                            <input type="checkbox" id="drip-irrigation-auto" data-price="4490">
                            <span class="product-name">Капельный полив автоматический</span>
                            <span class="price">4.490 рублей</span>
                        </label>
                    </div>
                    
                    <div class="product-item">
                        <label class="product-label">
                            <input type="checkbox" id="window-automation" data-price="2590">
                            <span class="product-name">Автомат для форточки</span>
                            <span class="price">2.590 рублей</span>
                        </label>
                    </div>
                    
                    <div class="product-item">
                        <label class="product-label">
                            <input type="checkbox" id="galvanized-tape-30m" data-price="1990">
                            <span class="product-name">Оцинкованная лента 30 м</span>
                            <span class="price">1.990 рублей</span>
                        </label>
                    </div>
                    
                    <div class="product-item">
                        <label class="product-label">
                            <input type="checkbox" id="vapor-permeable-tape-25m" data-price="1590">
                            <span class="product-name">Паропропускная лента 25 м</span>
                            <span class="price">1.590 рублей</span>
                        </label>
                    </div>
                    
                    <div class="product-item">
                        <label class="product-label">
                            <input type="checkbox" id="additional-window" data-price="1490">
                            <span class="product-name">Дополнительная форточка</span>
                            <span class="price">1.490 рублей</span>
                        </label>
                    </div>
                    
                    <div class="product-item">
                        <label class="product-label">
                            <input type="checkbox" id="additional-partition" data-price="5490">
                            <span class="product-name">Дополнительная перегородка</span>
                            <span class="price">5.490 рублей</span>
                        </label>
                    </div>
                    
                    <div class="product-item">
                        <label class="product-label">
                            <input type="checkbox" id="additional-partition-door" data-price="6990">
                            <span class="product-name">Дополнительная перегородка с дверью</span>
                            <span class="price">6.990 рублей</span>
                        </label>
                    </div>
                </div>

                <button onclick="calculateGreenhouseCost()">Рассчитать стоимость теплицы</button>
            </div>

            <!-- Блок коммерческого предложения -->
            <div class="block">
                <h2>Коммерческое предложение</h2>
                <textarea id="commercial-offer" rows="20" readonly>Здесь будет ваше коммерческое предложение.</textarea>
                <button onclick="copyCommercialOffer()">Скопировать КП</button>
            </div>
        </div>

        <script>
            // Константа для контроля отладки
            const DEBUG = true; 

            /**
             * Функция форматирования чисел с точками
             * @param {number} num - Число для форматирования
             * @returns {string} - Отформатированное число
             */
            function formatPrice(num) {
                if (typeof num !== "number") return num;
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }

            // Функция нормализации строки
            function normalizeString(str) {
                if (!str) return "";
                return str.trim().toLowerCase();
            }

            // Локальные пользователи
            const users = [
                { login: "admin", password: "Admin#2024" },
                { login: "Manager1", password: "Mng1!Secure" },
                { login: "Manager2", password: "Mng2#Strong" },
                { login: "Manager3", password: "Mng3!Complex" },
                { login: "Manager4", password: "Mng4#Robust" },
                { login: "Manager5", password: "Mng5!Power" },
                { login: "Manager6", password: "Mng6#Safety" },
                { login: "Manager7", password: "Mng7!Stable" },
                { login: "Manager8", password: "Mng8#Access" },
                { login: "Manager9", password: "Mng9!Control" },
                { login: "Manager10", password: "Mng10#Secure" }
            ];

            // Приоритет форм
            const formPriority = {
                "Арочная": 1,
                "Каплевидная": 2,
                "Прямостенная": 3,
                "Домиком": 4,
                "Пристенная": 5,
                "Митлайдер арочная": 6,
                "Митлайдер прямостенная": 7,
                "Промышленная прямостенная": 8,
                "Промышленная домиком": 9,
                "Навес": 10,
                "Прочие": 11
            };

            // Города и регионы доставки
            const deliveryRegions = [
                { city: "Москва", region: "Московская область" },
                { city: "Санкт-Петербург", region: "Ленинградская область" },
                { city: "Белгород", region: "Белгородская область" },
                { city: "Великий Новгород", region: "Новгородская область" },
                { city: "Владимир", region: "Владимирская область" },
                { city: "Вологда", region: "Вологодская область" },
                { city: "Воронеж", region: "Воронежская область" },
                { city: "Екатеринбург", region: "Свердловская область" },
                { city: "Иваново", region: "Ивановская область" },
                { city: "Йошкар-Ола", region: "Республика Марий Эл" },
                { city: "Казань", region: "Республика Татарстан" },
                { city: "Калуга", region: "Калужская область" },
                { city: "Кемерово", region: "Кемеровская область" },
                { city: "Кострома", region: "Костромская область" },
                { city: "Краснодар", region: "Краснодарский край" },
                { city: "Курск", region: "Курская область" },
                { city: "Липецк", region: "Липецкая область" },
                { city: "Майкоп", region: "Республика Адыгея" },
                { city: "Набережные Челны", region: "Республика Татарстан" },
                { city: "Нижний Новгород", region: "Нижегородская область" },
                { city: "Новосибирск", region: "Новосибирская область" },
                { city: "Орёл", region: "Орловская область" },
                { city: "Рязань", region: "Рязанская область" },
                { city: "Ставрополь", region: "Ставропольский край" },
                { city: "Тамбов", region: "Тамбовская область" },
                { city: "Тверь", region: "Тверская область" },
                { city: "Тула", region: "Тульская область" },
                { city: "Ульяновск", region: "Ульяновская область" },
                { city: "Чебоксары", region: "Чувашская Республика" },
                { city: "Челябинск", region: "Челябинская область" },
                { city: "Черкесск", region: "Карачаево-Черкесская Республика" },
                { city: "Ярославль", region: "Ярославская область" }
            ];

            // Города для карты
            const citiesForMap = [
                { name: "Москва", coords: [55.751244, 37.618423], boundaryDistance: 20 },
                { name: "Санкт-Петербург", coords: [59.934280, 30.335099], boundaryDistance: 20 },
                { name: "Белгород", coords: [50.597735, 36.585823], boundaryDistance: 10 },
                { name: "Великий Новгород", coords: [58.521400, 31.275505], boundaryDistance: 10 },
                { name: "Владимир", coords: [56.129057, 40.407031], boundaryDistance: 12 },
                { name: "Вологда", coords: [59.220492, 39.891568], boundaryDistance: 10 },
                { name: "Воронеж", coords: [51.661535, 39.200287], boundaryDistance: 15 },
                { name: "Екатеринбург", coords: [56.838926, 60.605703], boundaryDistance: 15 },
                { name: "Иваново", coords: [57.000348, 40.973921], boundaryDistance: 12 },
                { name: "Йошкар-Ола", coords: [56.634431, 47.899888], boundaryDistance: 12 },
                { name: "Казань", coords: [55.796391, 49.108891], boundaryDistance: 15 },
                { name: "Калуга", coords: [54.506043, 36.251593], boundaryDistance: 12 },
                { name: "Кемерово", coords: [55.354968, 86.087314], boundaryDistance: 15 },
                { name: "Кострома", coords: [57.767961, 40.926858], boundaryDistance: 10 },
                { name: "Краснодар", coords: [45.035470, 38.975313], boundaryDistance: 12 },
                { name: "Курск", coords: [51.730361, 36.192647], boundaryDistance: 10 },
                { name: "Липецк", coords: [52.610150, 39.594180], boundaryDistance: 12 },
                { name: "Майкоп", coords: [44.607782, 40.105690], boundaryDistance: 10 },
                { name: "Набережные Челны", coords: [55.727110, 52.404913], boundaryDistance: 12 },
                { name: "Нижний Новгород", coords: [56.296504, 43.936059], boundaryDistance: 15 },
                { name: "Новосибирск", coords: [55.008352, 82.935733], boundaryDistance: 15 },
                { name: "Орёл", coords: [52.967257, 36.069647], boundaryDistance: 10 },
                { name: "Рязань", coords: [54.629704, 39.741146], boundaryDistance: 12 },
                { name: "Ставрополь", coords: [45.044838, 41.969230], boundaryDistance: 10 },
                { name: "Тамбов", coords: [52.721219, 41.452274], boundaryDistance: 10 },
                { name: "Тверь", coords: [56.858539, 35.917596], boundaryDistance: 12 },
                { name: "Тула", coords: [54.193122, 37.617348], boundaryDistance: 12 },
                { name: "Ульяновск", coords: [54.316685, 48.403123], boundaryDistance: 12 },
                { name: "Чебоксары", coords: [56.146223, 47.251931], boundaryDistance: 12 },
                { name: "Челябинск", coords: [55.164442, 61.436843], boundaryDistance: 15 },
                { name: "Черкесск", coords: [44.226863, 42.046782], boundaryDistance: 10 },
                { name: "Ярославль", coords: [57.626559, 39.893813], boundaryDistance: 10 }
            ];

            // Доп. услуги (брус, штыри)
            const additionalServicesData = {
                "Брус": {
                    price_by_length: {
                        4: 6290,
                        6: 7790,
                        8: 9290,
                        10: 10790,
                        12: 12290,
                        14: 13790,
                        16: 15290
                    }
                },
                "Штыри": {
                    price_per_unit: 249,
                    quantity_by_length: {
                        "without_bracing": { "4": 10, "6": 14, "8": 18, "10": 22, "12": 26, "14": 30, "16": 34 },
                        "with_bracing": { "4": 6, "6": 10, "8": 14, "10": 18, "12": 22, "14": 26, "16": 30 }
                    }
                }
            };

            // Структура для сборки
            const assemblyPrices = {
                "Арочная": {
                    "2.5М": { 4: 4990, 6: 6490, 8: 7990, 10: 9490, 12: 11990 },
                    "3М": { 4: 4990, 6: 6490, 8: 7990, 10: 9490, 12: 11990 },
                    "3.5М": { 4: 5990, 6: 7990, 8: 9990, 10: 11990, 12: 13990 },
                    "4М": { 4: 7990, 6: 11490, 8: 14990, 10: 18490, 12: 22490 }
                },
                /* ... остальные формы */
            };

            // Определение доступных форм
            const availableForms = {
                "Арочная": [
                    { name: "ТЕПЛИЦА БОЯРСКАЯ 2.5М", frame: "20х20" },
                    { name: "ТЕПЛИЦА БОЯРСКАЯ 3М",   frame: "20х20" },
                    { name: "ТЕПЛИЦА БОЯРСКАЯ ЛЮКС 2.5М", frame: "40х20" },
                    { name: "ТЕПЛИЦА БОЯРСКАЯ ЛЮКС 3М",   frame: "40х20" },
                    { name: "ТЕПЛИЦА БОЯРСКАЯ ЛЮКС 3.5М", frame: "40х20" },
                    { name: "ТЕПЛИЦА БОЯРСКАЯ ДЕЛЮКС 2.5М", frame: "20х20+20х20" },
                    { name: "ТЕПЛИЦА БОЯРСКАЯ ДЕЛЮКС 3М",   frame: "20х20+20х20" },
                    { name: "ТЕПЛИЦА БОЯРСКАЯ ПРЕМИУМ 2.5М", frame: "40х20+20х20" },
                    { name: "ТЕПЛИЦА БОЯРСКАЯ ПРЕМИУМ 3М",   frame: "40х20+20х20" },
                    { name: "ТЕПЛИЦА БОЯРСКАЯ ПРЕМИУМ 3.5М", frame: "40х20+20х20" },
                    { name: "ТЕПЛИЦА БОЯРСКАЯ ПРЕМИУМ 4М",   frame: "40х20+20х20" }
                ],
                /* ... остальные */
            };

            // Сопоставление form_name->category
            const formNameToCategory = {};
            Object.keys(availableForms).forEach(category => {
                availableForms[category].forEach(form => {
                    formNameToCategory[normalizeString(form.name)] = category;
                });
            });
            function getFormCategory(fn) {
                if (!fn) return "Прочие";
                const norm=normalizeString(fn);
                return formNameToCategory[norm]||"Прочие";
            }

            // Supabase
            const SUPABASE_URL = 'https://dyoibmfdohpvjltfaygr.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJI...'; 
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            if (DEBUG) console.log("Supabase клиент инициализирован.");

            let currentCityData=[];
            let deliveryCost=0;
            let mapInstance;
            let currentRoute;

            ymaps.ready(() => {
                mapInstance = new ymaps.Map("map", {
                    center: [55.751244, 37.618423],
                    zoom: 7
                });
                if (DEBUG) console.log("Карта Яндекс инициализирована.");
            });

            // Аутентификация
            function authenticate() {
                const loginInput=document.getElementById("login");
                const passwordInput=document.getElementById("password");
                const authError=document.getElementById("auth-error");

                const login=loginInput.value.trim();
                const password=passwordInput.value.trim();

                const user=users.find(u=>u.login===login && u.password===password);
                if (user) {
                    authError.style.display="none";
                    localStorage.setItem('savedLogin', login);
                    document.getElementById("auth-container").classList.add("hidden");
                    document.getElementById("calculator-container").classList.remove("hidden");
                    initializeCalculator();
                } else {
                    authError.style.display="block";
                }
            }

            // Logout
            function logout() {
                localStorage.removeItem('savedLogin');
                document.getElementById("auth-container").classList.remove("hidden");
                document.getElementById("calculator-container").classList.add("hidden");
                if (mapInstance && currentRoute) {
                    mapInstance.geoObjects.remove(currentRoute);
                }
                resetDropdown('form','Сначала выберите город');
                resetDropdown('width','Сначала выберите форму');
                resetDropdown('length','Сначала выберите ширину');
                resetDropdown('frame','Сначала выберите длину');
                resetDropdown('polycarbonate','Сначала выберите город');
                resetDropdown('arcStep','Выберите шаг');
                resetAdditionalOptions();
                document.getElementById("commercial-offer").value="Здесь будет ваше коммерческое предложение.";
                document.getElementById("result").innerText="";
            }

            // Загрузка городов
            async function loadCities() {
                const pageSize=1000;
                let allCities=[];
                let page=0;
                while(true) {
                    let { data, error } = await supabaseClient
                        .from('prices')
                        .select('city_name')
                        .range(page*pageSize, (page+1)*pageSize-1);
                    if (error) {
                        console.error("Ошибка при загрузке городов:", error);
                        return;
                    }
                    if (!data || data.length===0) break;
                    allCities=allCities.concat(data.map(d=>d.city_name));
                    page++;
                }
                let uniqueCities=[...new Set(allCities)];
                const priority=["Москва","Санкт-Петербург"];
                uniqueCities=uniqueCities.filter(c=>!priority.includes(c));
                uniqueCities.sort((a,b)=>a.localeCompare(b,'ru'));
                const finalCities=[...priority,...uniqueCities];

                const cityDD=document.getElementById('city');
                cityDD.innerHTML='<option value="">Выберите город</option>';
                finalCities.forEach(c=>{
                    cityDD.innerHTML+=`<option value="${c}">${c}</option>`;
                });
            }

            // При смене города
            async function onCityChange(){
                const city=document.getElementById('city').value;
                if(!city) {
                    resetDropdown('form','Сначала выберите город');
                    resetDropdown('width','Сначала выберите форму');
                    resetDropdown('length','Сначала выберите ширину');
                    resetDropdown('frame','Сначала выберите длину');
                    resetDropdown('arcStep','Выберите шаг');
                    resetDropdown('polycarbonate','Сначала выберите город');
                    resetAdditionalOptions();
                    return;
                }

                let {data, error} = await supabaseClient
                    .from('prices')
                    .select('form_name, polycarbonate_type, width, length, frame_description, price, snow_load, height, horizontal_ties, equipment')
                    .eq('city_name', city)
                    .limit(30000);

                if(error) {
                    console.error("Ошибка при получении данных по городу:",error);
                    return;
                }
                if(!data||data.length===0){
                    alert("Данные для выбранного города не найдены.");
                    return;
                }
                currentCityData=data;

                // Упорядочим поликарбонаты
                const rawPolys=currentCityData.map(i=>i.polycarbonate_type).filter(Boolean);
                const uniqPolys=[...new Set(rawPolys)];
                const pref=["Стандарт 4 мм","Люкс 4 мм","Премиум 6 мм","Без поликарбоната"];
                const ordered=[];
                pref.forEach(pp=>{
                    if(uniqPolys.includes(pp)) ordered.push(pp);
                });
                uniqPolys.forEach(pp=>{
                    if(!pref.includes(pp)) ordered.push(pp);
                });

                const polyDD=document.getElementById('polycarbonate');
                polyDD.innerHTML="";
                ordered.forEach(pp=>{
                    const opt=document.createElement('option');
                    opt.value=pp;
                    opt.textContent=pp;
                    polyDD.appendChild(opt);
                });
                if(ordered.includes("Стандарт 4 мм")){
                    polyDD.value="Стандарт 4 мм";
                }

                // Формы
                const forms=Object.keys(availableForms);
                const formsAvail=forms.filter(ff=> currentCityData.some(item=>getFormCategory(item.form_name)===ff));
                formsAvail.sort((a,b)=>(formPriority[a]||99)-(formPriority[b]||99));

                const formDD=document.getElementById('form');
                formDD.innerHTML="";
                formsAvail.forEach(ff=>{
                    const o=document.createElement('option');
                    o.value=ff;
                    o.textContent=ff;
                    formDD.appendChild(o);
                });
                // если есть "Арочная", ставим её
                if(formsAvail.includes("Арочная")){
                    formDD.value="Арочная";
                } else if(formsAvail.length>0){
                    formDD.value=formsAvail[0];
                }

                resetDropdown('width','Сначала выберите форму');
                resetDropdown('length','Сначала выберите ширину');
                resetDropdown('frame','Сначала выберите длину');
                document.getElementById('arcStep').value="1";
                resetAdditionalOptions();
            }

            // При смене формы
            function onFormChange(){
                const form=document.getElementById('form').value;
                const widthDD=document.getElementById('width');
                widthDD.innerHTML='<option value="">Выберите ширину</option>';
                if(!form)return;

                const filtered=currentCityData.filter(i=>getFormCategory(i.form_name)===form);
                if(filtered.length===0)return;

                const widths=[...new Set(filtered.map(i=>i.width))].sort((a,b)=>a-b);
                widths.forEach(w=>{
                    widthDD.innerHTML+=`<option value="${w}">${w} м</option>`;
                });

                resetDropdown('length','Сначала выберите ширину');
                resetDropdown('frame','Сначала выберите длину');
                document.getElementById('arcStep').value="1";
                resetAdditionalOptions();
            }

            // При смене ширины
            function onWidthChange(){
                const form=document.getElementById('form').value;
                const wVal=parseFloat(document.getElementById('width').value);
                const lengthDD=document.getElementById('length');
                lengthDD.innerHTML='<option value="">Выберите длину</option>';
                if(!wVal)return;

                const filtered=currentCityData.filter(i=>
                    getFormCategory(i.form_name)===form && parseFloat(i.width)===wVal
                );
                if(filtered.length===0)return;

                const lengths=[...new Set(filtered.map(i=>i.length))].sort((a,b)=>a-b);
                lengths.forEach(L=>{
                    lengthDD.innerHTML+=`<option value="${L}">${L} м</option>`;
                });

                resetDropdown('frame','Сначала выберите длину');
                document.getElementById('arcStep').value="1";
                resetAdditionalOptions();
            }

            // При смене длины
            function onLengthChange(){
                const form=document.getElementById('form').value;
                const w=parseFloat(document.getElementById('width').value);
                const L=parseFloat(document.getElementById('length').value);
                const frameDD=document.getElementById('frame');
                frameDD.innerHTML='<option value="">Выберите каркас</option>';
                if(!L)return;

                const filtered=currentCityData.filter(i=>{
                    return (getFormCategory(i.form_name)===form &&
                            parseFloat(i.width)===w &&
                            parseFloat(i.length)===L);
                });
                if(filtered.length===0)return;

                let uniqueFrames=[...new Set(filtered.map(i=>i.frame_description))];
                const frameOrder=["20х20","40х20","20х20+20х20","40х20+20х20"];

                // Ищем в тексте "20х20", "40х20" и т.д. Если нашлось — берём это
                uniqueFrames=uniqueFrames.map(fr=>{
                    const match=fr.match(/(20х20\+20х20|40х20\+20х20|20х20|40х20)/i);
                    return match?match[0]:fr;
                });
                uniqueFrames=[...new Set(uniqueFrames)];

                uniqueFrames.sort((a,b)=>{
                    const iA=frameOrder.indexOf(a);
                    const iB=frameOrder.indexOf(b);
                    if(iA===-1 && iB===-1) return a.localeCompare(b);
                    if(iA===-1) return 1;
                    if(iB===-1) return -1;
                    return iA-iB;
                });

                uniqueFrames.forEach(f=>{
                    frameDD.innerHTML+=`<option value="${f}">${f}</option>`;
                });
                document.getElementById('arcStep').value="1";
                resetAdditionalOptions();
            }

            // При смене каркаса
            function onFrameChange(){
                resetDropdown('arcStep','Выберите шаг');
                document.getElementById('arcStep').value="1";
                resetAdditionalOptions();
            }

            // Сброс dropdown
            function resetDropdown(id,placeholder){
                const el=document.getElementById(id);
                if(!el)return;
                if(id==='arcStep') {
                    el.value='1';
                } else {
                    el.innerHTML=`<option value="">${placeholder}</option>`;
                }
            }

            // Сброс опций
            function resetAdditionalOptions(){
                const pr=document.querySelectorAll('.additional-products input[type="checkbox"]');
                pr.forEach(ch=>ch.checked=false);
                const sv=document.querySelectorAll('.additional-services input[type="checkbox"]');
                sv.forEach(ch=>ch.checked=false);
            }

            // Расчёт доставки
            async function calculateDelivery(){
                const address=document.getElementById('address').value.trim();
                const deliveryType=document.querySelector('input[name="deliveryType"]:checked').value;
                if(!address){
                    document.getElementById('result').innerText="Введите адрес!";
                    return;
                }
                try{
                    const res=await ymaps.geocode(address);
                    const geoObject=res.geoObjects.get(0);
                    if(!geoObject) {
                        document.getElementById('result').innerText="Адрес не найден!";
                        return;
                    }
                    const localities=geoObject.getLocalities().map(l=>l.toLowerCase());
                    const adminAreas=geoObject.getAdministrativeAreas().map(a=>a.toLowerCase());
                    const isInReg=deliveryRegions.some(r=>
                        localities.includes(r.city.toLowerCase()) || adminAreas.includes(r.region.toLowerCase())
                    );
                    if(!isInReg){
                        document.getElementById('result').innerText="Доставка в этот регион не осуществляется.";
                        return;
                    }
                    const coords=geoObject.geometry.getCoordinates();
                    const [destLat,destLon]=coords;
                    let nearest=null, minDist=Infinity;
                    citiesForMap.forEach(city=>{
                        const dist=ymaps.coordSystem.geo.getDistance(city.coords,[destLat,destLon])/1000;
                        if(dist<minDist){
                            minDist=dist; nearest=city;
                        }
                    });
                    if(!nearest){
                        document.getElementById('result').innerText="Ошибка: ближайший город не найден.";
                        return;
                    }
                    if(currentRoute){
                        mapInstance.geoObjects.remove(currentRoute);
                    }
                    const route=await ymaps.route([nearest.coords,[destLat,destLon]]);
                    currentRoute=route;
                    mapInstance.geoObjects.add(route);

                    const distKm=route.getLength()/1000;
                    const distFromBoundary=Math.max(distKm - nearest.boundaryDistance,0);
                    let cost=0;
                    if(deliveryType==="withoutAssembly"){
                        cost=Math.max(1000, 500 + 40*distFromBoundary);
                    } else {
                        cost=Math.max(1000, 40*distFromBoundary);
                    }
                    const rounded=Math.ceil(cost/50)*50;
                    deliveryCost=rounded;
                    document.getElementById('result').innerText=`Стоимость доставки: ${formatPrice(rounded)} рублей (${nearest.name})`;
                } catch(e){
                    document.getElementById('result').innerText="Ошибка при расчёте. Попробуйте снова.";
                }
            }

            // Сборка
            function getAssemblyCategory(form,width){
                return `${width}М`;
            }
            function calculateAssemblyCost(form,cat,length){
                if(!assemblyPrices[form]||!assemblyPrices[form][cat])return 0;
                return assemblyPrices[form][cat][length]||0;
            }

            // Расчёт стоимости теплицы
            function calculateGreenhouseCost(){
                const city=document.getElementById('city').value;
                const form=document.getElementById('form').value;
                const wVal=parseFloat(document.getElementById('width').value);
                const LVal=parseFloat(document.getElementById('length').value);
                const frame=document.getElementById('frame').value;
                const poly=document.getElementById('polycarbonate').value;
                const arc=parseFloat(document.getElementById('arcStep').value);

                if(!city||!form||isNaN(wVal)||isNaN(LVal)||!frame||!poly||isNaN(arc)){
                    alert("Пожалуйста, заполните все поля (город, форма, ширина, длина, каркас, поликарбонат, шаг дуг).");
                    return;
                }
                if(!currentCityData||currentCityData.length===0){
                    alert("Нет данных по городу. Выберите город.");
                    return;
                }

                const sel=currentCityData.find(it=>{
                    return ( getFormCategory(it.form_name)===form &&
                             parseFloat(it.width)===wVal &&
                             parseFloat(it.length)===LVal &&
                             normalizeString(it.frame_description).includes(normalizeString(frame)) &&
                             normalizeString(it.polycarbonate_type)===normalizeString(poly) );
                });
                if(!sel){
                    alert("Теплица с такими параметрами не найдена.");
                    return;
                }

                let snowLoad=parseFloat(sel.snow_load)||0;
                let basePrice=sel.price||0;
                let basePriceText=`Стоимость с учетом скидки - ${formatPrice(basePrice)} рублей`;

                // Наценка за 0.65 м
                if(arc===0.65){
                    const baseStd=currentCityData.find(item=>
                        getFormCategory(item.form_name)===form &&
                        parseFloat(item.width)===wVal &&
                        parseFloat(item.length)===LVal &&
                        normalizeString(item.frame_description).includes(normalizeString(frame)) &&
                        normalizeString(item.polycarbonate_type)==="стандарт 4 мм"
                    );
                    if(baseStd){
                        const baseStdPrice=baseStd.price||0;
                        const addCost=0.25*baseStdPrice;
                        basePrice+=addCost;
                        basePriceText=`Стоимость с учетом скидки - ${formatPrice(basePrice)} рублей`;
                        snowLoad=Math.round(snowLoad*1.25);
                    }
                }

                // Люкс 4 мм => +10%
                if(normalizeString(poly)==="люкс 4 мм"){
                    snowLoad=Math.round(snowLoad*1.1);
                }
                // Премиум 6 мм => +20%
                if(normalizeString(poly)==="премиум 6 мм"){
                    snowLoad=Math.round(snowLoad*1.2);
                }

                let assemblyCost=0, foundationCost=0, additionalProductsCost=0;
                const bracingCh=document.getElementById('bracing').checked;
                const groundHooksCh=document.getElementById('ground-hooks').checked;
                const assemblyCh=document.getElementById('assembly').checked;
                const onWoodCh=document.getElementById('on-wood').checked;
                const onConcreteCh=document.getElementById('on-concrete').checked;

                // Брус
                if(bracingCh){
                    const br=additionalServicesData["Брус"].price_by_length[LVal];
                    if(!br){
                        alert("Не найдена стоимость бруса для данной длины.");
                        return;
                    }
                    foundationCost+=br;
                }
                // Штыри
                if(groundHooksCh){
                    const qt= bracingCh
                        ? additionalServicesData["Штыри"].quantity_by_length["with_bracing"]
                        : additionalServicesData["Штыри"].quantity_by_length["without_bracing"];
                    const st=qt[LVal];
                    if(!st){
                        alert("Не найдены данные по штырям для этой длины.");
                        return;
                    }
                    foundationCost+=st*additionalServicesData["Штыри"].price_per_unit;
                }

                // Сборка
                if(assemblyCh){
                    const cat=getAssemblyCategory(form,wVal);
                    const ac=calculateAssemblyCost(form,cat,LVal);
                    assemblyCost+=ac;
                } else {
                    // Монтаж на фундамент
                    if(onWoodCh){
                        let wpr=parseFloat(document.getElementById('on-wood').getAttribute('data-price'))||0;
                        foundationCost+=wpr;
                    }
                    if(onConcreteCh){
                        let cpr=parseFloat(document.getElementById('on-concrete').getAttribute('data-price'))||0;
                        foundationCost+=cpr;
                    }
                }

                // Дополнительные товары
                const prodChecks=document.querySelectorAll('.additional-products input[type="checkbox"]');
                const chosenProducts=[];
                prodChecks.forEach(cb=>{
                    if(cb.checked){
                        const nmEl=cb.parentElement.querySelector('.product-name');
                        const nm=nmEl? nmEl.textContent.trim() : "Товар";
                        const pr=parseFloat(cb.getAttribute('data-price'))||0;
                        if(pr>0){
                            additionalProductsCost+=pr;
                            chosenProducts.push({ name:nm, cost:pr });
                        }
                    }
                });

                let totalNoDelivery=basePrice+assemblyCost+foundationCost+additionalProductsCost;
                totalNoDelivery=Math.ceil(totalNoDelivery/10)*10;
                const finalTotal=totalNoDelivery+deliveryCost;

                generateCommercialOffer({
                    basePrice, 
                    basePriceText,
                    assemblyCost, 
                    foundationCost, 
                    additionalProductsCost, 
                    chosenProducts,
                    deliveryPrice: deliveryCost,
                    finalTotal,
                    snowLoad,
                    selectedEntry: sel
                });
            }

            // Формируем КП
            function generateCommercialOffer({
                basePrice, 
                basePriceText,
                assemblyCost, 
                foundationCost,
                additionalProductsCost, 
                chosenProducts,
                deliveryPrice, 
                finalTotal,
                snowLoad,
                selectedEntry
            }){
                const height=selectedEntry.height||"Не указано";
                const horizontalTies=selectedEntry.horizontal_ties||"Не указано";
                const equipment=selectedEntry.equipment||"Не указано";
                const formName=selectedEntry.form_name||"ТЕПЛИЦА";

                const frameVal=document.getElementById('frame').value;
                const widthVal=document.getElementById('width').value;
                const lengthVal=document.getElementById('length').value;
                const arcVal=document.getElementById('arcStep').value;
                const polyVal=document.getElementById('polycarbonate').value;

                const upperName=formName.toUpperCase();
                const cleanName=upperName.startsWith("ТЕПЛИЦА")?upperName:`ТЕПЛИЦА ${upperName}`;

                let commercialOffer=`${cleanName}\n\n`+
                    `Каркас: ${frameVal}\n`+
                    `Ширина: ${widthVal} м\n`+
                    `Длина: ${lengthVal} м\n`+
                    `Высота: ${height}\n`+
                    `Шаг дуги: ${arcVal} м\n`+
                    `Поликарбонат с УФ защитой: ${polyVal}\n`+
                    `Снеговая нагрузка: ${snowLoad}\n`+
                    `Горизонтальные стяжки: ${horizontalTies}\n`+
                    `Комплектация: ${equipment}\n\n`+
                    `${basePriceText}\n`;

                if(assemblyCost>0){
                    commercialOffer+=`Сборка: +${formatPrice(assemblyCost)} рублей\n`;
                }
                if(foundationCost>0){
                    commercialOffer+=`Основание / Монтаж: +${formatPrice(foundationCost)} рублей\n`;
                }
                if(chosenProducts.length>0){
                    commercialOffer+=`\nДополнительные товары:\n`;
                    chosenProducts.forEach(p=>{
                        commercialOffer+=`  - ${p.name}: ${formatPrice(p.cost)} руб.\n`;
                    });
                }
                if(deliveryPrice>0){
                    commercialOffer+=`\nДоставка: ${formatPrice(deliveryPrice)} руб.\n`;
                }
                commercialOffer+=`\nИтоговая стоимость с доставкой: ${formatPrice(finalTotal)} рублей`;

                document.getElementById('commercial-offer').value=commercialOffer;
            }

            // Копирование КП
            function copyCommercialOffer(){
                const offerText=document.getElementById('commercial-offer');
                offerText.select();
                offerText.setSelectionRange(0,99999);
                document.execCommand("copy");
                alert("Коммерческое предложение скопировано!");
            }

            // Инициализация при загрузке страницы
            window.onload=async function(){
                const savedLogin=localStorage.getItem('savedLogin');
                if(savedLogin){
                    document.getElementById("auth-container").classList.add("hidden");
                    document.getElementById("calculator-container").classList.remove("hidden");
                    await initializeCalculator();
                }
            }

            async function initializeCalculator(){
                await loadCities();
                addAdditionalProductsEventListeners();
            }

            function addAdditionalProductsEventListeners(){
                const additionalProducts=document.querySelectorAll('.additional-products input[type="checkbox"]');
                additionalProducts.forEach(checkbox=>{
                    checkbox.addEventListener('change', calculateGreenhouseCost);
                });
                const additionalServices=document.querySelectorAll('.additional-services input[type="checkbox"]');
                additionalServices.forEach(checkbox=>{
                    checkbox.addEventListener('change', calculateGreenhouseCost);
                });
                const arcStepEl=document.getElementById('arcStep');
                arcStepEl.addEventListener('change', calculateGreenhouseCost);
                const polyEl=document.getElementById('polycarbonate');
                polyEl.addEventListener('change', calculateGreenhouseCost);
            }
        </script>
    </div>
</body>
</html>
